"use strict";var app=angular.module("clientApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]);app.constant("FIREBASE_URL","https://itsybid.firebaseio.com/"),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/landing.html",controller:"PostsCtrl"}).when("/auctions",{templateUrl:"views/auctions.html",controller:"PostsCtrl"}).when("/about",{templateUrl:"views/about.html"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl",resolve:{user:function(a){return a.resolveUser()}}}).when("/create",{templateUrl:"views/create.html",controller:"PostsCtrl",resolve:{user:function(a){return a.resolveUser()}}}).when("/auction/:auctionId",{templateUrl:"views/auction.html",controller:"PostViewCtrl",resolve:{user:function(a){return a.resolveUser()}}}).when("/users/:userId",{templateUrl:"views/profile.html",controller:"ProfileCtrl",resolve:{user:function(a){return a.resolveUser()}}}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl",resolve:{user:function(a){return a.resolveUser()}}}).otherwise({redirectTo:"/"})}]),app.controller("PostsCtrl",["$scope","Post","Auth","Helper","$location",function(a,b,c,d,e){a.posts=b.all,a.user=c.user,a.deletePost=function(a){b.delete(a)},a.timeLeft=function(){console.log("Calculating end time"),console.log(moment(a.endTime,"dddd DD MMM, h:mm A").fromNow()),a.timeLeftString=moment(a.endTime,"dddd DD MMM, h:mm A").fromNow()},d.jQueryDT(),a.createAuction=function(){var c={title:a.title,description:a.description,creatorUID:a.user.profile.uid,creatorName:a.user.profile.username,createTime:Firebase.ServerValue.TIMESTAMP,startPrice:a.startPrice,endTime:100*moment(a.endTime,"dddd DD MMM, h:mm A").unix()};b.create(c).then(function(a){e.path("/auction/"+a.name())}),a.commentText=""}}]),app.controller("PostViewCtrl",["$scope","$routeParams","Post","Auth","$firebase",function(a,b,c,d,e){a.auction=c.get(b.auctionId),a.comments=c.comments(b.auctionId),a.bids=c.bids(b.auctionId),a.user=d.user,a.signedIn=d.signedIn,a.placeBid=function(c){c&&(a.bidamount=a.currentPrice()+c);var d={bidderName:a.user.profile.username,bidderId:a.user.profile.uid,timestamp:Firebase.ServerValue.TIMESTAMP,bidamount:a.bidamount};a.bids.$add(d).then(function(a){var c={winningBidder:d.bidderName,winningBidderUID:d.bidderId,winningBidderAmount:d.bidamount,winningBidderBidId:a.name()};e(new Firebase("https://itsybid.firebaseio.com/auction/"+b.auctionId)).$update(c)}),a.bidamount=""},a.currentPrice=function(){return a.auction.winningBidder?(console.log("Found winning bidder:"+a.auction.winningBidderAmount),a.auction.winningBidderAmount):(console.log("No winning bidder. So use start amount: "+a.auction.startPrice),a.auction.startPrice)},a.addComment=function(){if(a.commentText&&""!==a.commentText){var b={text:a.commentText,creator:a.user.profile.username,creatorUID:a.user.profile.uid};a.comments.$add(b),a.commentText=""}},a.deleteComment=function(b){a.comments.$remove(b)}}]),app.controller("NavCtrl",["$scope","$location","Auth",function(a,b,c){a.signedIn=c.signedIn,a.logout=c.logout,a.user=c.user,a.post={url:"http://",title:""},a.submitPost=function(){a.post.creator=a.user.profile.username,a.post.creatorUID=a.user.uid,Post.create(a.post).then(function(c){a.post={url:"http://",title:""},b.path("/posts/"+c.name())})},a.user=c.user,a.signedIn=c.signedIn,a.logout=c.logout}]),app.controller("AuthCtrl",["$scope","$location","Auth","user",function(a,b,c,d){d&&b.path("/"),a.login=function(){c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(d){return c.login(a.user).then(function(){return d.username=a.user.username,c.createProfile(d)}).then(function(){b.path("/")})},function(b){a.error=b.toString()})}}]),app.controller("ProfileCtrl",["$scope","$routeParams","Profile",function(a,b,c){var d=b.userId;a.user=c.get(d),c.getPosts(d).then(function(b){a.posts=b})}]),app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),app.filter("timeLeft",function(){return function(a){return console.log("Calculating time until "+a),moment(a,"dddd DD MMM, h:mm A").fromNow()}}),app.filter("formatTime",function(){return function(a){return moment(a).format("dddd DD MMM, h:mm A")}}),app.filter("dateFormatter",function(){return function(a,b){var c=moment.unix(a).format("dddd DD MMM, h:mm A");return""===c&&b&&(c=b),c}}),app.filter("dateFromNow",function(){return function(a,b){var c=moment.unix(a).fromNow();return""===c&&b&&(c=b),c}}),app.filter("commaThousands",function(){return function(a){var b="0";return a&&(b=a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")),b}}),app.filter("capitaliseFirstLetter",function(){return function(a,b){if(a){var c=a.charAt(0).toUpperCase()+a.slice(1);return""===c&&b&&(c=b),c}return""}}),app.filter("reverse",function(){function a(a){var b,c=[];if(a)if(angular.isArray(a))c=a;else if("object"==typeof a)for(b in a)a.hasOwnProperty(b)&&c.push(a[b]);return c}return function(b){return a(b).slice().reverse()}}),app.factory("Post",["$firebase","FIREBASE_URL",function(a,b){var c=new Firebase(b),d=c.child("auction"),e=c.child("comments"),f=c.child("user_posts"),g=a(d).$asArray(),h={all:g,create:function(b){return g.$add(b).then(function(c){return a(f.child(b.creatorUID)).$push(c.name()),c})},get:function(b){return console.log("Post.get("+b+")"),a(d.child(b)).$asObject()},"delete":function(a){g.$remove(a)},comments:function(b){return a(e.child(b)).$asArray()},bids:function(b){return a(d.child(b).child("bids")).$asArray().reverse()},topBid:function(){}};return h}]),app.factory("Auth",["$firebase","$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c,d){var e=new Firebase(c),f=b(e),g={register:function(a){return console.log("trying to register user"),f.$createUser(a.email,a.password)},createProfile:function(b){var c={username:b.username,uid:b.uid,md5_hash:b.md5_hash},d=a(e.child("profile"));return d.$set(b.uid,c)},login:function(a){return console.log("trying to log in"),f.$login("password",a)},logout:function(){console.log("trying to log out"),f.$logout()},resolveUser:function(){return console.log("getting current user"),f.$getCurrentUser()},signedIn:function(){return!!g.user.provider},user:{}};return d.$on("$firebaseSimpleLogin:login",function(b,c){angular.copy(c,g.user),g.user.profile=a(e.child("profile").child(g.user.uid)).$asObject(),g.user.profile.uid=c.uid,console.group("User logged in "+c.email),console.log(g.user.profile),console.groupEnd()}),d.$on("$firebaseSimpleLogin:logout",function(){console.log("logged out"),g.user&&g.user.profile&&g.user.profile.$destroy(),angular.copy({},g.user)}),g}]),app.factory("Profile",["$window","FIREBASE_URL","$firebase","Post","$q",function(a,b,c,d,e){var f=new a.Firebase(b),g=f.child("profile"),h=f.child("user_posts"),i={get:function(a){return c(g.child(a)).$asObject()},getPosts:function(a){var b=e.defer();return c(h.child(a)).$asArray().$loaded().then(function(a){for(var c={},e=0;e<a.length;e++){var f=a[e].$value;c[f]=d.get(f)}b.resolve(c)}),b.promise}};return i}]),app.factory("Helper",["$window",function(){var a={jQueryDT:function(){jQuery(".datetimepicker").datetimepicker({minDate:moment().add(1,"minute"),defaultDate:moment().add(1,"hour").minutes(0),sideBySide:!0,stepping:15,useCurrent:!1})}};return a}]);